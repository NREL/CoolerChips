<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Model Demonstration V1.1</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .container-fluid {
            margin: 10px;
            padding: 10px;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .table thead th, .table tbody td {
            vertical-align: middle;
            white-space: nowrap;
        }
        .form-control {
            padding: 0.375rem 0.75rem;
            height: auto;
        }
        .graph-container {
            margin-top: 20px;
            text-align: center;
        }
        .editable {
            background-color: #f9f9f9;
        }
        .table-wider th, .table-wider td {
            min-width: 120px;
        }
        .sub-column {
            display: flex;
            justify-content: space-between;
        }
        .checkbox-column {
            width: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mt-4">Cost Model Demonstration V2.0</h1>

        <div class="mt-3">
            <a href="/settings" class="btn btn-secondary" onclick="saveState()">Default Parameters</a>
            <!-- <a href="/elements.html" class="btn btn-secondary" onclick="saveState()">Cost Elements Menu</a>-->
            <a href="/dataCenter" class="btn btn-secondary" onclick="saveState()">Data Center Parameters</a>
            <button class="btn btn-secondary" id="saveBtn" onclick="saveState()">Save</button>
            <button class="btn btn-secondary" id="loadBtn" onclick="loadState()">Load</button>
        </div>

        <form id="fileForm" method="post" action="/process_file" onsubmit="return handleFormSubmit(event);">
            <div class="form-group" id="file1-group">
                <label for="file1">Add the Reference Case HTM/SQL file:</label>
                <input type="file" class="form-control" id="file1" name="file1" onchange="showModal(this, 'file1')">
                <div class="mt-2 mb-2">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addModal">Add</button>
                    <button type="button" class="btn btn-danger" onclick="removeSelectedRows('file1')">Remove</button>
                    <button type="button" class="btn btn-warning" onclick="clearTable('file1')">Clear</button>
                    <button type="button" class="btn btn-secondary" onclick="duplicateTable()">Duplicate Reference Table to Analysis Case</button>
                </div>
                <div class="table-container">
                    <table class="table table-bordered" id="file1-table">
                        <thead>
                            <tr>
                                <th class="checkbox-column"><input type="checkbox" id="selectAllFile1" class="selectRow"></th>
                                <th>Name</th>
                                <th>Units</th>
                                <th>Cost per Equipment</th>
                                <th>Redundancy</th>
                                <th>Total Cost</th>
                                <th>MTBF</th>
                                <th>Gamma (hours)</th>
                                <th>Beta</th>
                                <th>Eta (hours)</th>
                                <th>Cost per Maintenance Event</th>
                                <th>Maintenance Type</th>
                            </tr>
                        </thead>
                        <tbody id="file1-details">
                            <!-- Data will be inserted here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="11">Total</th>
                                <th id="file1-totalCost"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="energy-value" style="margin-top: 20px; font-weight: bold;"></div>
            </div>

            <div class="form-group" id="file2-group">
                <label for="file2">Add the Analysis Case HTM/SQL file:</label>
                <input type="file" class="form-control" id="file2" name="file2" onchange="showModal(this, 'file2')">
                <div class="mt-2 mb-2">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addModal">Add</button>
                    <button type="button" class="btn btn-danger" onclick="removeSelectedRows('file2')">Remove</button>
                    <button type="button" class="btn btn-warning" onclick="clearTable('file2')">Clear</button>
                </div>
                <div class="table-container">
                    <table class="table table-bordered" id="file2-table">
                        <thead>
                            <tr>
                                <th class="checkbox-column"><input type="checkbox" id="selectAllFile2" class="selectRow"></th>
                                <th>Name</th>
                                <th>Units</th>
                                <th>Cost per Equipment</th>
                                <th>Redundancy</th>
                                <th>Total Cost</th>
                                <th>MTBF</th>
                                <th>Gamma (hours)</th>
                                <th>Beta</th>
                                <th>Eta (hours)</th>
                                <th>Cost per Maintenance Event</th>
                                <th>Maintenance Type</th>
                            </tr>
                        </thead>
                        <tbody id="file2-details">
                            <!-- Data will be inserted here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="11">Total</th>
                                <th id="file2-totalCost"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="energy-value" style="margin-top: 20px; font-weight: bold;"></div>
            </div>
            <button type="button" class="btn btn-primary" onclick="generateGraph()">Submit</button>
        </form>

        <!-- Modal for input -->
        <div class="modal fade" id="inputModal" tabindex="-1" role="dialog" aria-labelledby="inputModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="inputModalLabel">Enter Values</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="modalForm">
                            <div class="form-group">
                                <label for="modalMTBF">MTBF:</label>
                                <input type="text" class="form-control" id="modalMTBF">
                            </div>
                            <div class="form-group">
                                <label for="modalGamma">Gamma (hours):</label>
                                <input type="text" class="form-control" id="modalGamma">
                            </div>
                            <div class="form-group">
                                <label for="modalBeta">Beta:</label>
                                <input type="text" class="form-control" id="modalBeta">
                            </div>
                            <div class="form-group">
                                <label for="modalEta">Eta (hours):</label>
                                <input type="text" class="form-control" id="modalEta">
                            </div>
                            <div class="form-group">
                                <label for="modalCostPerMaintenanceEvent">Cost per Maintenance Event:</label>
                                <input type="text" class="form-control" id="modalCostPerMaintenanceEvent">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="submitModalForm()">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for adding a new component -->
        <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addModalLabel">Add New Cooling System Component</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addModalForm">
                            <div class="form-group">
                                <label for="modalName">Name:</label>
                                <input type="text" class="form-control" id="modalName">
                            </div>
                            <div class="form-group">
                                <label for="modalCostPerEquipment">Cost per Equipment:</label>
                                <input type="text" class="form-control" id="modalCostPerEquipment">
                            </div>
                            <div class="form-group">
                                <label for="modalRedundancy">Redundancy:</label>
                                <select class="form-control" id="modalRedundancy">
                                    <option value="N">N</option>
                                    <option value="N+1">N+1</option>
                                    <option value="N+2">N+2</option>
                                    <option value="2N">2N</option>
                                    <option value="2N+1">2N+1</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="modalMTBF">MTBF:</label>
                                <input type="text" class="form-control" id="modalMTBF">
                            </div>
                            <div class="form-group">
                                <label for="modalGamma">Gamma (hours):</label>
                                <input type="text" class="form-control" id="modalGamma">
                            </div>
                            <div class="form-group">
                                <label for="modalBeta">Beta:</label>
                                <input type="text" class="form-control" id="modalBeta">
                            </div>
                            <div class="form-group">
                                <label for="modalEta">Eta (hours):</label>
                                <input type="text" class="form-control" id="modalEta">
                            </div>
                            <div class="form-group">
                                <label for="modalCostPerMaintenanceEvent">Cost per Maintenance Event:</label>
                                <input type="text" class="form-control" id="modalCostPerMaintenanceEvent">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="addNewComponent('file1')">Add to Reference</button>
                        <button type="button" class="btn btn-primary" onclick="addNewComponent('file2')">Add to Analysis</button>
                    </div>
                </div>
            </div>
        </div>



        <div class="graph-container" id="graphContainer">
            <!-- The generated graphs will be displayed here -->
            <div id="roiGraphContainer"></div>
            <div id="irrGraphContainer"></div>
            <div id="npvGraphContainer"></div>
        </div>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <script id="initial-data" type="application/json"
            data-cooling-system-details-ref='{{ cooling_system_details_ref|safe }}'
            data-cooling-system-details-analysis='{{ cooling_system_details_analysis|safe }}'
            data-variables='{{ variables|safe }}'
            data-data-center-details='{{ data_center_details|safe }}'
            data-graphs-displayed='{{ graphs_displayed|safe }}'></script>
        <script>
            let currentFileInput;

            function restoreState(loadedData) {
                Cooling_System_Details_Ref = loadedData.Cooling_System_Details_Ref;
                Cooling_System_Details_Analysis = loadedData.Cooling_System_Details_Analysis;
                document.getElementById('file1-details').innerHTML = loadedData.tableDisplayed;
                document.getElementById('npv-graph').innerHTML = loadedData.graphsDisplayed.npv;
                document.getElementById('roi-graph').innerHTML = loadedData.graphsDisplayed.roi;
                document.getElementById('irr-graph').innerHTML = loadedData.graphsDisplayed.irr;
                variables = loadedData.variables;
                dataCenterDetails = loadedData.dataCenterDetails;
            }

            document.addEventListener('DOMContentLoaded', function() {
                restoreState();

                // Attach the dblclick event to table cells after restoring state
                attachEditableEvents();
            });

            function attachEditableEvents() {
                const cells = document.querySelectorAll('#file1-details td, #file2-details td');
                cells.forEach(cell => {
                    cell.addEventListener('dblclick', makeEditable);
                });
            }

            function showModal(input, fileId) {
                currentFileInput = input;
                currentFileInput.fileId = fileId;
                $('#inputModal').modal('show');
            }

            function submitModalForm() {
                const mtbf = document.getElementById('modalMTBF').value;
                const gamma = document.getElementById('modalGamma').value;
                const beta = document.getElementById('modalBeta').value;
                const eta = document.getElementById('modalEta').value;
                const costPerMaintenanceEvent = document.getElementById('modalCostPerMaintenanceEvent').value;

                if (mtbf && gamma && beta && eta && costPerMaintenanceEvent) {
                    const reader = new FileReader();
                    reader.onload = function() {
                        const content = reader.result;

                        // Remove existing hidden inputs if they exist
                        removeHiddenInputs(currentFileInput.fileId);

                        // Add new hidden inputs
                        addHiddenInput(currentFileInput.fileId, 'mtbf', mtbf.trim());
                        addHiddenInput(currentFileInput.fileId, 'gamma', gamma.trim());
                        addHiddenInput(currentFileInput.fileId, 'beta', beta.trim());
                        addHiddenInput(currentFileInput.fileId, 'eta', eta.trim());
                        addHiddenInput(currentFileInput.fileId, 'costPerMaintenanceEvent', costPerMaintenanceEvent.trim());

                        const formData = new FormData();
                        formData.append('fileContent', content);
                        formData.append('mtbf', mtbf.trim());
                        formData.append('gamma', gamma.trim());
                        formData.append('beta', beta.trim());
                        formData.append('eta', eta.trim());
                        formData.append('costPerMaintenanceEvent', costPerMaintenanceEvent.trim());

                        fetch('/process_file', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log("Server response received", data);
                            displayCoolingSystemDetails(data.cooling_system_details, currentFileInput.fileId);
                            calculateTotalCost(data.total_cooling_cost);
                            updateGraphs(data.roi_image, data.irr_image, data.npv_image);
                        })
                        .catch(error => {
                            console.error("Error occurred:", error);
                        });

                        $('#inputModal').modal('hide');
                    };
                    reader.onerror = function() {
                        console.error("Could not read file");
                    };
                    reader.readAsText(currentFileInput.files[0]);
                } else {
                    alert("All values are required.");
                }
            }

            function addNewComponent(fileId) {
                const name = document.getElementById('modalName').value;
                const costPerEquipment = document.getElementById('modalCostPerEquipment').value;
                const redundancy = document.getElementById('modalRedundancy').value;
                const mtbf = document.getElementById('modalMTBF').value;
                const gamma = document.getElementById('modalGamma').value;
                const beta = document.getElementById('modalBeta').value;
                const eta = document.getElementById('modalEta').value;
                const costPerMaintenanceEvent = document.getElementById('modalCostPerMaintenanceEvent').value;

                console.log("Captured values: ", { name, costPerEquipment, redundancy, mtbf, gamma, beta, eta, costPerMaintenanceEvent });

                if (name && costPerEquipment && redundancy && mtbf && gamma && beta && eta && costPerMaintenanceEvent) {
                    fetch('/add_cooling_system', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name.trim(),
                            costPerEquipment: costPerEquipment.trim(),
                            redundancy: redundancy.trim(),
                            mtbf: mtbf.trim(),
                            gamma: gamma.trim(),
                            beta: beta.trim(),
                            eta: eta.trim(),
                            costPerMaintenanceEvent: costPerMaintenanceEvent.trim(),
                            fileId: fileId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Component added successfully", data);
                        displayCoolingSystemDetails(data.cooling_system_details, fileId);
                        calculateTotalCost(data.total_cooling_cost);
                    })
                    .catch(error => {
                        console.error("Error occurred while adding component", error);
                    });

                    $('#addModal').modal('hide');
                } else {
                    alert("All values are required.");
                }
            }

            function removeHiddenInputs(fileId) {
                const hiddenInputs = document.querySelectorAll(`#${fileId}-group input[type='hidden']`);
                hiddenInputs.forEach(input => input.remove());
            }

            function addHiddenInput(fileId, name, value) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = `${fileId}-${name}`;
                input.name = name;
                input.value = value;
                document.getElementById(fileId + '-group').appendChild(input);
            }

            function updateRedundancy(rowIndex, redundancy) {
                fetch('/update_redundancy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        index: rowIndex,
                        redundancy: redundancy
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Redundancy updated successfully", data);
                    displayCoolingSystemDetails(data.cooling_system_details, currentFileInput.fileId);
                    calculateTotalCost(data.total_cooling_cost);
                })
                .catch(error => {
                    console.error("Error occurred while updating redundancy", error);
                });
            }

            function handleFormSubmit(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                formData.append('mtbf', document.getElementById('modalMTBF').value);
                formData.append('gamma', document.getElementById('modalGamma').value);
                formData.append('beta', document.getElementById('modalBeta').value);
                formData.append('eta', document.getElementById('modalEta').value);
                formData.append('costPerMaintenanceEvent', document.getElementById('modalCostPerMaintenanceEvent').value);

                $.ajax({
                    url: '/process_file',
                    method: 'POST',
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function(response) {
                        console.log('Success:', response); // Debugging line
                        displayCoolingSystemDetails(response.cooling_system_details);
                        displayEnergyValue(response.energy_per_hour);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error processing file:', error); // Debugging line
                    }
                });
            }

            function updateTable(details) {
                let tbody = "";
                details.forEach((row, index) => {
                    tbody += "<tr>";
                    row.forEach((cell, cellIndex) => {
                        if (cellIndex === 0) { // Checkbox column
                            tbody += `<td><input type="checkbox" class="selectRow"></td>`;
                        } else if (cellIndex === 2) { // Units column
                            tbody += `<td>
                                        <select class="form-control">
                                            <option value="per_datacenter" ${cell === 'per_datacenter' ? 'selected' : ''}>per Datacenter</option>
                                            <option value="per_room" ${cell === 'per_room' ? 'selected' : ''}>per Room</option>
                                            <option value="per_row" ${cell === 'per_row' ? 'selected' : ''}>per Row</option>
                                            <option value="per_server" ${cell === 'per_server' ? 'selected' : ''}>per Server</option>
                                            <option value="per_rack" ${cell === 'per_rack' ? 'selected' : ''}>per Rack</option>
                                        </select>
                                    </td>`;
                        } else if (cellIndex === 4) { // Redundancy column
                            tbody += `<td>
                                        <select class="form-control">
                                            <option value="N" ${cell === 'N' ? 'selected' : ''}>N</option>
                                            <option value="N+1" ${cell === 'N+1' ? 'selected' : ''}>N+1</option>
                                            <option value="N+2" ${cell === 'N+2' ? 'selected' : ''}>N+2</option>
                                            <option value="2N" ${cell === '2N' ? 'selected' : ''}>2N</option>
                                            <option value="2N+1" ${cell === '2N+1' ? 'selected' : ''}>2N+1</option>
                                        </select>
                                    </td>`;
                        } else if (cellIndex === 11) { // Maintenance Type column
                            tbody += `<td>
                                        <select class="form-control">
                                            <option value="Cost per maintenance" ${cell === 'Cost per maintenance' ? 'selected' : ''}>Cost per maintenance</option>
                                            <option value="% of purchase price" ${cell === '% of purchase price' ? 'selected' : ''}>% of purchase price</option>
                                            <option value="Flat fee per year" ${cell === 'Flat fee per year' ? 'selected' : ''}>Flat fee per year</option>
                                        </select>
                                    </td>`;
                        } else {
                            tbody += `<td>${cell}</td>`;
                        }
                    });
                    tbody += "</tr>";
                });

                document.getElementById('file2-details').innerHTML = tbody;
            }

            function displayEnergyValue(energy_per_hour) {
                const energyValueElement = document.getElementById('energy-value');
                energyValueElement.innerText = `Energy per hour: ${energy_per_hour}`;
            }

            function plotGraphs(npv_values, roi_values, irr_values, years) {
                // Plot NPV
                const npvData = [{
                    x: years,
                    y: npv_values,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'NPV'
                }];
                const npvLayout = {
                    title: 'NPV Over Time',
                    xaxis: { title: 'Year' },
                    yaxis: { title: 'NPV ($)' }
                };
                Plotly.newPlot('npvGraphContainer', npvData, npvLayout);

                // Plot ROI
                const roiData = [{
                    x: years,
                    y: roi_values,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'ROI'
                }];
                const roiLayout = {
                    title: 'ROI Over Time',
                    xaxis: { title: 'Year' },
                    yaxis: { title: 'ROI' }
                };
                Plotly.newPlot('roiGraphContainer', roiData, roiLayout);

                // Plot IRR
                const irrData = [{
                    x: years,
                    y: irr_values,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'IRR'
                }];
                const irrLayout = {
                    title: 'IRR Over Time',
                    xaxis: { title: 'Year' },
                    yaxis: { title: 'IRR' }
                };
                Plotly.newPlot('irrGraphContainer', irrData, irrLayout);
            }

            function displayCoolingSystemDetails(details, fileId) {
                let tbody = "";
                details.forEach((row, index) => {
                    if (index === 0) return; // Skip the header row
                    tbody += "<tr>";
                    tbody += `<td><input type="checkbox" class="selectRow"></td>`;
                    tbody += `<td>${row[0]}</td>`; // Name
                    tbody += `<td>
                                <select class="form-control">
                                    <option value="per_datacenter" ${row[1] === 'per_datacenter' ? 'selected' : ''}>per Datacenter</option>
                                    <option value="per_room" ${row[1] === 'per_room' ? 'selected' : ''}>per Room</option>
                                    <option value="per_row" ${row[1] === 'per_row' ? 'selected' : ''}>per Row</option>
                                    <option value="per_server" ${row[1] === 'per_server' ? 'selected' : ''}>per Server</option>
                                    <option value="per_rack" ${row[1] === 'per_rack' ? 'selected' : ''}>per Rack</option>
                                </select>
                              </td>`;
                    tbody += `<td>${row[2]}</td>`; // Cost per Equipment
                    tbody += `<td>
                                <select class="form-control" onchange="updateRedundancy(${index - 1}, this.value)">
                                    <option value="N" ${row[3] === 'N' ? 'selected' : ''}>N</option>
                                    <option value="N+1" ${row[3] === 'N+1' ? 'selected' : ''}>N+1</option>
                                    <option value="N+2" ${row[3] === 'N+2' ? 'selected' : ''}>N+2</option>
                                    <option value="2N" ${row[3] === '2N' ? 'selected' : ''}>2N</option>
                                    <option value="2N+1" ${row[3] === '2N+1' ? 'selected' : ''}>2N+1</option>
                                </select>
                              </td>`;
                    tbody += `<td>${row[4]}</td>`; // Total Cost
                    tbody += `<td>${row[5]}</td>`; // MTBF
                    tbody += `<td>${row[6]}</td>`; // Gamma
                    tbody += `<td>${row[7]}</td>`; // Beta
                    tbody += `<td>${row[8]}</td>`; // Eta
                    tbody += `<td>${row[9]}</td>`; // Cost per Maintenance Event
                    tbody += `<td>
                                <select class="form-control" onchange="updateMaintenanceType(${index - 1}, this.value)">
                                    <option value="Cost per maintenance" ${row[10] === 'Cost per maintenance' ? 'selected' : ''}>Cost per maintenance</option>
                                    <option value="% of purchase price" ${row[10] === '% of purchase price' ? 'selected' : ''}>% of purchase price</option>
                                    <option value="Flat fee per year" ${row[10] === 'Flat fee per year' ? 'selected' : ''}>Flat fee per year</option>
                                </select>
                              </td>`;
                    tbody += "</tr>";
                });

                document.getElementById(`${fileId}-details`).innerHTML = tbody;
                updateTotalCost(fileId);
            }

            function duplicateTable() {
                // Request user input
                let userInput = prompt("Enter the percentage for duplication:", "100");

                // Validate user input
                if (userInput === null || userInput.trim() === "") {
                    alert("Input is required to proceed.");
                    return;
                }

                userInput = parseFloat(userInput);
                if (isNaN(userInput) || userInput <= 0) {
                    alert("Please enter a valid positive number.");
                    return;
                }

                // Gather data from the first table
                const tableData = [];
                const rows = document.querySelectorAll('#file1-details tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = Array.from(cells).map(cell => cell.innerText.trim());
                    tableData.push(rowData);
                });

                // Debugging: Log the extracted table data
                console.log('Extracted table data:', tableData);

                // Send data to the server
                $.ajax({
                    url: '/duplicateTable',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ tableData: tableData, percentage: userInput }),
                    success: function(response) {
                        console.log('Success:', response); // Debugging line
                        updateSecondTable(response.cooling_system_details_analysis);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error duplicating table:', error); // Debugging line
                    }
                });
            }

            function updateSecondTable(details) {
                const tbody = document.getElementById('file2-details');
                tbody.innerHTML = ""; // Clear existing data

                details.slice(1).forEach((row, index) => {  // Skip the first row
                    const tr = document.createElement('tr');

                    // Add checkbox in the first column
                    const checkboxTd = document.createElement('td');
                    checkboxTd.classList.add('checkbox-column');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('selectRowFile2');
                    checkboxTd.appendChild(checkbox);
                    tr.appendChild(checkboxTd);

                    row.forEach((cell, cellIndex) => {
                        const td = document.createElement('td');

                        // Add the select elements in their respective columns
                        if (cellIndex === 1) {
                            // Units column
                            const select = document.createElement('select');
                            select.classList.add('form-control');
                            ['per_datacenter', 'per_room', 'per_row', 'per_server', 'per_rack'].forEach(optionValue => {
                                const option = document.createElement('option');
                                option.value = optionValue;
                                option.text = optionValue.replace('_', ' ');
                                if (cell === optionValue) {
                                    option.selected = true;
                                }
                                select.appendChild(option);
                            });
                            td.appendChild(select);
                        } else if (cellIndex === 4) {
                            // Redundancy column
                            const select = document.createElement('select');
                            select.classList.add('form-control');
                            ['N', 'N+1', 'N+2', '2N', '2N+1'].forEach(optionValue => {
                                const option = document.createElement('option');
                                option.value = optionValue;
                                option.text = optionValue;
                                if (cell === optionValue) {
                                    option.selected = true;
                                }
                                select.appendChild(option);
                            });
                            td.appendChild(select);
                        } else if (cellIndex === 11) {
                            // Maintenance Type column
                            const select = document.createElement('select');
                            select.classList.add('form-control');
                            ['Cost per maintenance', '% of purchase price', 'Flat fee per year'].forEach(optionValue => {
                                const option = document.createElement('option');
                                option.value = optionValue;
                                option.text = optionValue;
                                if (cell === optionValue) {
                                    option.selected = true;
                                }
                                select.appendChild(option);
                            });
                            td.appendChild(select);
                        } else {
                            td.textContent = cell;
                        }

                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });
            }



            function updateTotalCost(fileId) {
                const rows = document.querySelectorAll(`#${fileId}-details tr`);
                let totalCost = 0;
                rows.forEach(row => {
                    const cells = row.children;
                    const costPerEquipment = parseFloat(cells[3].textContent.replace(/[^0-9.-]+/g, ""));
                    const redundancy = cells[4].querySelector('select').value;
                    let multiplier = 1;
                    if (redundancy === "N+1") {
                        multiplier = 2;
                    } else if (redundancy === "N+2") {
                        multiplier = 3;
                    } else if (redundancy === "2N") {
                        multiplier = 2;
                    } else if (redundancy === "2N+1") {
                        multiplier = 3;
                    }
                    const totalCostForRow = costPerEquipment * multiplier;
                    cells[5].textContent = `$${totalCostForRow.toFixed(2)}`;
                    totalCost += totalCostForRow;
                });
                document.getElementById(`${fileId}-totalCost`).textContent = `$${totalCost.toFixed(2)}`;
            }

            function calculateTotalCost(totalCost) {
                document.getElementById('file1-totalCost').textContent = totalCost;
                document.getElementById('file2-totalCost').textContent = totalCost;
            }

            function clearTable(fileId) {
                document.getElementById(`${fileId}-details`).innerHTML = "";
                document.getElementById(`${fileId}-totalCost`).textContent = "";
            }

            function updateMaintenanceType(rowIndex, maintenanceType) {
                fetch('/update_maintenance_type', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        index: rowIndex,
                        maintenanceType: maintenanceType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Maintenance type updated successfully", data);
                    displayCoolingSystemDetails(data.cooling_system_details, currentFileInput.fileId);
                    calculateTotalCost(data.total_cooling_cost);
                })
                .catch(error => {
                    console.error("Error occurred while updating maintenance type", error);
                });
            }

            function removeSelectedRows(fileId) {
                console.log(`Removing selected rows for fileId: ${fileId}`);

                // Select the table body of the specified file
                const tableBody = document.querySelector(`#${fileId}-details`);

                // Select all checkboxes within the table body
                const selectedRows = tableBody.querySelectorAll('.selectRow:checked');
                console.log(`Selected checkboxes:`, selectedRows);

                const indicesToRemove = [];
                selectedRows.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const index = Array.from(tableBody.children).indexOf(row);
                    indicesToRemove.push(index);
                    console.log(`Row to remove:`, row.innerText, `at index: ${index}`);
                });

                console.log(`Indices to remove:`, indicesToRemove);

                if (indicesToRemove.length > 0) {
                    fetch('/remove_cooling_system', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ indices: indicesToRemove, fileId: fileId })
                    })
                    .then(response => {
                        console.log(`Server response status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Rows removed successfully", data);
                        if (data.error) {
                            console.error("Error from server:", data.error);
                            return;
                        }
                        displayCoolingSystemDetails(data.cooling_system_details, fileId);
                        calculateTotalCost(data.total_cooling_cost);
                    })
                    .catch(error => {
                        console.error("Error occurred while removing rows", error);
                    });
                } else {
                    alert("No rows selected for removal. Please select at least one checkbox.");
                }
            }

            function makeEditable(event) {
                const cell = event.target;
                const originalContent = cell.innerText;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalContent;
                input.className = 'form-control editable';
                
                input.addEventListener('blur', function() {
                    saveCellChanges(cell, input.value, originalContent);
                });

                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        saveCellChanges(cell, input.value, originalContent);
                    } else if (event.key === 'Escape') {
                        cell.innerText = originalContent;
                    }
                });

                cell.innerText = '';
                cell.appendChild(input);
                input.focus();
            }

            function saveCellChanges(cell, newValue, originalContent) {
                cell.innerText = newValue;
                if (newValue !== originalContent) {
                    const row = cell.parentNode;
                    const table = row.parentNode;
                    const rowIndex = Array.prototype.indexOf.call(table.children, row);
                    const cellIndex = Array.prototype.indexOf.call(row.children, cell);
                    
                    updateCell(rowIndex, cellIndex, newValue);
                }
            }

            function updateCell(rowIndex, cellIndex, newValue) {
                fetch('/update_cell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rowIndex: rowIndex,
                        cellIndex: cellIndex,
                        newValue: newValue
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Cell updated successfully', data);
                    // Optionally, you can refresh the table or show a success message
                })
                .catch(error => {
                    console.error('Error occurred while updating cell', error);
                });
            }

            function generateGraph() {
                console.log('Button clicked'); // Debugging line
                $.ajax({
                    url: '/generateGraphs',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ time_years: [1, 2, 3, 4] }), // Adjust the time_years data as needed
                    success: function(response) {
                        console.log('Success:', response); // Debugging line
                        $('#roiGraphContainer').html('<img src="data:image/png;base64,' + response.roi_image + '" class="img-fluid" />');
                        $('#irrGraphContainer').html('<img src="data:image/png;base64,' + response.irr_image + '" class="img-fluid" />');
                        $('#npvGraphContainer').html('<img src="data:image/png;base64,' + response.npv_image + '" class="img-fluid" />');
                    },
                    error: function(xhr, status, error) {
                        console.error('Error generating graph:', error); // Debugging line
                    }
                });
            }

            function saveState() {
                const state = {
                    coolingSystemDetailsRef: coolingSystemDetailsRef,
                    coolingSystemDetailsAnalysis: coolingSystemDetailsAnalysis,
                    variables: variables,
                    dataCenterDetails: dataCenterDetails,
                    graphsDisplayed: graphsDisplayed
                };

                const blob = new Blob([JSON.stringify(state)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'state.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function loadStateFromFile(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const loadedData = JSON.parse(e.target.result);
                        restoreState(loadedData);
                    };
                    reader.readAsText(file);
                }
            }

            function loadState() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const state = JSON.parse(e.target.result);
                            fetch('/load_state', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(state)
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    location.reload(); // Reload the page to reflect the loaded state
                                } else {
                                    alert('Failed to load state');
                                }
                            })
                            .catch(error => {
                                console.error('Error loading state:', error);
                                alert('Error loading state');
                            });
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            }

            function loadInitialData() {
                const scriptTag = document.getElementById('initial-data');
                const coolingSystemDetailsRef = JSON.parse(scriptTag.getAttribute('data-cooling-system-details-ref'));
                const coolingSystemDetailsAnalysis = JSON.parse(scriptTag.getAttribute('data-cooling-system-details-analysis'));
                const variables = JSON.parse(scriptTag.getAttribute('data-variables'));
                const dataCenterDetails = JSON.parse(scriptTag.getAttribute('data-data-center-details'));
                const graphsDisplayed = JSON.parse(scriptTag.getAttribute('data-graphs-displayed'));

                // Use the loaded data in your JavaScript
                console.log(coolingSystemDetailsRef, coolingSystemDetailsAnalysis, variables, dataCenterDetails, graphsDisplayed);
            }

            function updateFirstTable(details) {
                let tbody = "";
                details.forEach((row, index) => {
                    tbody += "<tr>";
                    if (index === 0) {  // Header row
                        row.forEach(cell => {
                            tbody += `<th>${cell}</th>`;
                        });
                    } else {  // Data rows
                        tbody += `<td class="checkbox-column"><input type="checkbox" class="selectRowFile1"></td>`;
                        row.forEach((cell, cellIndex) => {
                            if (cellIndex === 2) {  // Units column
                                tbody += `<td>
                                            <select class="form-control">
                                                <option value="per_datacenter" ${cell === 'per_datacenter' ? 'selected' : ''}>per Datacenter</option>
                                                <option value="per_room" ${cell === 'per_room' ? 'selected' : ''}>per Room</option>
                                                <option value="per_row" ${cell === 'per_row' ? 'selected' : ''}>per Row</option>
                                                <option value="per_server" ${cell === 'per_server' ? 'selected' : ''}>per Server</option>
                                                <option value="per_rack" ${cell === 'per_rack' ? 'selected' : ''}>per Rack</option>
                                            </select>
                                        </td>`;
                            } else if (cellIndex === 4) {  // Redundancy column
                                tbody += `<td>
                                            <select class="form-control">
                                                <option value="N" ${cell === 'N' ? 'selected' : ''}>N</option>
                                                <option value="N+1" ${cell === 'N+1' ? 'selected' : ''}>N+1</option>
                                                <option value="N+2" ${cell === 'N+2' ? 'selected' : ''}>N+2</option>
                                                <option value="2N" ${cell === '2N' ? 'selected' : ''}>2N</option>
                                                <option value="2N+1" ${cell === '2N+1' ? 'selected' : ''}>2N+1</option>
                                            </select>
                                        </td>`;
                            } else if (cellIndex === 11) {  // Maintenance Type column
                                tbody += `<td>
                                            <select class="form-control">
                                                <option value="Cost per maintenance" ${cell === 'Cost per maintenance' ? 'selected' : ''}>Cost per maintenance</option>
                                                <option value="% of purchase price" ${cell === '% of purchase price' ? 'selected' : ''}>% of purchase price</option>
                                                <option value="Flat fee per year" ${cell === 'Flat fee per year' ? 'selected' : ''}>Flat fee per year</option>
                                            </select>
                                        </td>`;
                            } else {
                                tbody += `<td ondblclick="makeEditable(this)">${cell}</td>`;
                            }
                        });
                    }
                    tbody += "</tr>";
                });

                document.getElementById('file1-details').innerHTML = tbody;
                updateTotalCost('file1');
            }

            function updateSecondTable(details) {
                let tbody = "";
                details.forEach((row, index) => {
                    tbody += "<tr>";
                    if (index === 0) {  // Header row
                        row.forEach(cell => {
                            tbody += `<th>${cell}</th>`;
                        });
                    } else {  // Data rows
                        tbody += `<td class="checkbox-column"><input type="checkbox" class="selectRowFile2"></td>`;
                        row.forEach((cell, cellIndex) => {
                            if (cellIndex === 2) {  // Units column
                                tbody += `<td>
                                            <select class="form-control">
                                                <option value="per_datacenter" ${cell === 'per_datacenter' ? 'selected' : ''}>per Datacenter</option>
                                                <option value="per_room" ${cell === 'per_room' ? 'selected' : ''}>per Room</option>
                                                <option value="per_row" ${cell === 'per_row' ? 'selected' : ''}>per Row</option>
                                                <option value="per_server" ${cell === 'per_server' ? 'selected' : ''}>per Server</option>
                                                <option value="per_rack" ${cell === 'per_rack' ? 'selected' : ''}>per Rack</option>
                                            </select>
                                        </td>`;
                            } else if (cellIndex === 4) {  // Redundancy column
                                tbody += `<td>
                                            <select class="form-control">
                                                <option value="N" ${cell === 'N' ? 'selected' : ''}>N</option>
                                                <option value="N+1" ${cell === 'N+1' ? 'selected' : ''}>N+1</option>
                                                <option value="N+2" ${cell === 'N+2' ? 'selected' : ''}>N+2</option>
                                                <option value="2N" ${cell === '2N' ? 'selected' : ''}>2N</option>
                                                <option value="2N+1" ${cell === '2N+1' ? 'selected' : ''}>2N+1</option>
                                            </select>
                                        </td>`;
                            } else if (cellIndex === 11) {  // Maintenance Type column
                                tbody += `<td>
                                            <select class="form-control">
                                                <option value="Cost per maintenance" ${cell === 'Cost per maintenance' ? 'selected' : ''}>Cost per maintenance</option>
                                                <option value="% of purchase price" ${cell === '% of purchase price' ? 'selected' : ''}>% of purchase price</option>
                                                <option value="Flat fee per year" ${cell === 'Flat fee per year' ? 'selected' : ''}>Flat fee per year</option>
                                            </select>
                                        </td>`;
                            } else {
                                tbody += `<td ondblclick="makeEditable(this)">${cell}</td>`;
                            }
                        });
                    }
                    tbody += "</tr>";
                });

                document.getElementById('file2-details').innerHTML = tbody;
                updateTotalCost('file2');
            }

            document.getElementById('saveBtn').addEventListener('click', saveState);
            document.getElementById('loadBtn').addEventListener('click', loadState);

        </script>
    </div>
</body>
</html>
